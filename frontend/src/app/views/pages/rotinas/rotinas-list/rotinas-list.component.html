<div class="mb-2 align-items-center gap-2 d-flex justify-content-between flex-wrap">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-arrow mb-1">
      <li class="breadcrumb-item">
        <i class="feather icon-repeat"></i>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ 'ROTINAS.TITLE' | translate }}
      </li>
    </ol>
  </nav>

  <button type="button" class="btn btn-primary btn-icon-text btn-xs" [routerLink]="['/rotinas/novo']" [ngbTooltip]="'ROTINAS.NEW_ROTINA_TOOLTIP' | translate">
    <i class="feather icon-plus btn-icon-prepend"></i>
    {{ 'ROTINAS.NEW_ROTINA' | translate }}
  </button>
</div>

<div class="row">
  <div class="col-md-12 stretch-card">
    <div class="card">
      <div class="card-body">

        <!-- Filtros -->
        <div class="row mb-3">
          <div class="col-md-4">
            <ng-select id="pilarFilter" [(ngModel)]="pilarIdFiltro" (ngModelChange)="onFilterChange()"
              [placeholder]="'ROTINAS.ALL_PILARES' | translate" [clearable]="true">
              <ng-option *ngFor="let pilar of pilares" [value]="pilar.id">
                {{ pilar.nome }}
              </ng-option>
            </ng-select>
          </div>
          <div class="col-md-8">
            <div class="alert alert-info mb-0" *ngIf="!canReorder">
              {{ 'ROTINAS.SELECT_PILAR_TO_REORDER' | translate }}
            </div>
            <div class="alert alert-success mb-0" *ngIf="canReorder">
              {{ 'ROTINAS.DRAG_TO_REORDER' | translate }}
            </div>
          </div>
        </div>

        @if (loading) {
        <!-- Loading -->
        <div class="text-center py-5" *ngIf="loading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
          </div>
        </div>
        } @else {

        <!-- Table -->

        <!-- Table with Drag and Drop -->
        <div class="table-responsive" *ngIf="totalRotinas > 0">
          <table class="table table-hover table-striped mb-2">
            <thead>
              <tr>
                <th *ngIf="canReorder" style="width: 40px;"></th>
                <th>{{ 'ROTINAS.FIELDS.PILAR' | translate }}</th>
                <th>{{ 'ROTINAS.FIELDS.ROTINA' | translate }}</th>
                <th style="width: 120px;">{{ 'COMMON.ACTIONS' | translate }}</th>
              </tr>
            </thead>
            <tbody cdkDropList [cdkDropListDisabled]="!canReorder" (cdkDropListDropped)="onDrop($event)">
              <tr *ngFor="let rotina of paginatedRotinas" cdkDrag [cdkDragDisabled]="!canReorder" data-testid="rotina-list-item">
                <td *ngIf="canReorder" class="text-center">
                  <i class="feather icon-list me-2"></i>
                </td>
                <td style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  {{ rotina.pilar?.nome || '—' }}
                </td>
                <td style="max-width: 500px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                  <span class="badge bg-secondary small" [ngbTooltip]="'ROTINAS.FIELDS.ORDER' | translate">{{ rotina.ordem }}</span>
                  <span [ngbTooltip]="rotina.nome"> {{ rotina.nome }} </span>
                </td>
                <td class="text-nowrap">
                  <div class="btn-group btn-group-sm" role="group">
                    <!-- Detalhes -->
                    <button class="btn btn-icon text-primary"
                      (click)="openDetailsOffcanvas(rotina.id, detailsOffcanvas)"
                      [title]="'ROTINAS.DETAILS_TOOLTIP' | translate">
                      <i class="feather icon-info"></i>
                    </button>

                    <!-- Toggle Ativar/Inativar -->
                    <button class="btn btn-icon text-primary"
                        (click)="toggleStatus(rotina.id, rotina.nome, rotina.ativo)"
                        [title]="rotina.ativo ? 'Inativar rotina' : 'Ativar rotina'">
                        <i class="feather"
                          [ngClass]="{'icon-toggle-right': rotina.ativo, 'icon-toggle-left': !rotina.ativo}"></i>
                    </button>

                    <!-- Editar (sempre visível) -->
                    <button class="btn btn-icon text-secondary" [routerLink]="['/rotinas/editar', rotina.id]"
                      [title]="'ROTINAS.EDIT_TOOLTIP' | translate">
                      <i class="feather icon-edit"></i>
                    </button>

                    <!-- Excluir (visível se ativo) -->
                    @if (rotina.ativo) {
                    <button class="btn btn-icon text-danger" (click)="confirmarExclusao(rotina)"
                      [title]="'ROTINAS.DELETE_TOOLTIP' | translate">
                      <i class="feather icon-trash-2"></i>
                    </button>
                    }
                  </div>
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Pagination -->
        <div class="d-flex justify-content-between p-2">
          <span class="text-muted fs-12">
            Mostrando {{ getStartIndex() + 1 }}-{{ getEndIndex() }} de {{ totalRotinas }} {{ 'COMMON.ITEMS' | translate }}
          </span>
          <ngb-pagination [(page)]="page" [pageSize]="pageSize" [collectionSize]="totalRotinas" size="sm"
            [rotate]="true" [boundaryLinks]="true">
          </ngb-pagination>
        </div>

        }
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas de Detalhes da Rotina -->
<ng-template #detailsOffcanvas let-offcanvas>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">{{ 'ROTINAS.DETAILS' | translate }}</h5>
    <button type="button" class="btn-close text-reset" (click)="offcanvas.dismiss()"></button>
  </div>
  <div class="offcanvas-body">
    @if (loadingDetails) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}</span>
      </div>
      <p class="text-muted mt-3">{{ 'COMMON.LOADING' | translate }}...</p>
    </div>
    } @else if (selectedRotina) {
    <div class="mb-4">
      <h4 class="mb-2">{{ selectedRotina.nome }}</h4>

      <span class="badge" [ngClass]="{ 'bg-success': selectedRotina.ativo, 'bg-danger': !selectedRotina.ativo }">
        {{ selectedRotina.ativo ? ('COMMON.ACTIVE' | translate) : ('COMMON.INACTIVE' | translate) }}
      </span>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h6 class="card-title mb-3">{{ 'COMMON.BASIC_INFO' | translate }}</h6>
        @if (selectedRotina.descricao) {
        <div class="mb-3">
          <span class="text-muted small">{{ 'ROTINAS.FIELDS.DESCRIPTION' | translate }}</span>
          <div class="mt-1">{{ selectedRotina.descricao }}</div>
        </div>
        }
        @if (selectedRotina.ordem) {
        <div class="mb-2">
          <span class="text-muted small">{{ 'ROTINAS.FIELDS.ORDER' | translate }}</span>
          <div>{{ selectedRotina.ordem }}</div>
        </div>
        }
        @if (selectedRotina.pilar) {
        <div class="mb-0">
          <span class="text-muted small">{{ 'ROTINAS.FIELDS.PILAR' | translate }}</span>
          <div>{{ selectedRotina.pilar.nome }}</div>
        </div>
        }
      </div>
    </div>

    <div class="d-grid gap-2">
      <button type="button" class="btn btn-primary" [routerLink]="['/rotinas/editar', selectedRotina.id]"
        (click)="offcanvas.dismiss()">
        <i class="feather icon-edit"></i> {{ 'BUTTONS.EDIT' | translate }}
      </button>
    </div>
    }
  </div>
</ng-template>