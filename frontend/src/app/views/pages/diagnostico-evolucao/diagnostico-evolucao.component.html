<div id="headerEmpresa" class="mb-1">
    <div class="mb-2 align-items-center d-flex justify-content-between flex-wrap">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-arrow">
                <li class="breadcrumb-item">
                    <i class="feather icon-trending-up"></i>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    {{ 'EVOLUCAO.TITLE' | translate }}
                </li>
            </ol>
        </nav>

        <!-- Botão Congelar -->
        @if (canCongelar) {
        <button type="button" class="btn btn-outline-primary btn-sm"
            ngbTooltip="Congelar médias do período de avaliação atual e criar snapshots de todos os pilares"
            (click)="congelarMedias()" [disabled]="!periodoAtual || medias.length === 0">
            <i class="feather icon-archive"></i>
            Atualizar Histórico {{ getPeriodoMesAno() }}
        </button>
        }
    </div>
</div>

<!-- Conteúdo principal -->
@if (!loading && !error && selectedEmpresaId && medias.length > 0) {
<!-- Tabela de Pilares com Médias -->
<div class="card mb-2">
    <div class="card-body py-2">
        <div class="table-responsive" style="max-width: 90%; margin: 0 auto;">
            <table class="table table-sm mb-0">
                <thead class="table-light">
                    <tr>
                        <th class="py-2 w-100">{{ 'PILARES.PILAR' | translate }}</th>
                        <th sortable="mediaAtual" [direction]="sortColumn === 'mediaAtual' ? sortDirection : ''"
                            (sort)="onSort($event)" class="text-center py-2">{{ 'EVOLUCAO.MEDIA_ATUAL'
                            | translate }}</th>
                        <th class="text-center py-2">Última Atualização</th>
                    </tr>
                </thead>
                <tbody>
                    @for (media of getSortedMedias(); track media.pilarEmpresaId) {
                    <tr>
                        <td class="py-2">
                            <i class="feather icon-layers me-1"></i>
                            {{ media.pilarNome.toUpperCase() }}
                        </td>
                        <td class="text-center py-2">
                            <app-media-badge [media]="media.mediaAtual" [justMedia]="true"></app-media-badge>
                        </td>
                        <td class="text-center py-2">
                            <small class="text-muted">
                                @if (media.ultimaAtualizacao) {
                                <i class="feather icon-clock me-1"></i>
                                {{ formatarData(media.ultimaAtualizacao) }}
                                } @else {
                                <span class="text-muted">-</span>
                                }
                            </small>
                        </td>
                    </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Gráfico de Colunas por Data -->
<div class="card">
    <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
            <div class="d-flex align-items-center gap-3">
                <h5 class="card-title mb-0">{{ 'EVOLUCAO.GRAFICO_TITLE' | translate }}</h5>
            </div>
            <!-- Filtro de Ano -->
            <ng-select 
                [(ngModel)]="anoFiltro"
                (ngModelChange)="onAnoChange()"
                [items]="anosDisponiveis"
                [clearable]="true"
                [searchable]="false"
                placeholder="Filtrar por ano"
                class="ng-select-sm"
                style="width: 150px;">
            </ng-select>


        </div>
        <p class="text-muted small mb-3">
            <i class="feather icon-info me-1"></i>
            Cada pilar exibe suas médias congeladas por período (mês/ano do trimestre)
        </p>

        <div style="overflow-x: auto; overflow-y: hidden;">
            <div id="chartContainer" style="min-width: 100%; position: relative;">
                <canvas id="evolucaoBarChart"></canvas>
            </div>
        </div>

        @if (historico.length === 0) {
        <div class="empty-state" style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%);">
            <i class="feather icon-bar-chart-2"></i>
            <p>{{ 'EVOLUCAO.NO_HISTORICO' | translate }}</p>
        </div>
        }
    </div>
</div>
}

<!-- Loading -->
@else if (loading) {
<div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}...</span>
    </div>
</div>
}

<!-- Error -->
@else if (error && !loading) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    {{ error }}
</div>
}

<!-- Estado vazio -->
@else if (!loading && !error && medias.length === 0 && selectedEmpresaId) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    <span>{{ 'EVOLUCAO.NO_MEDIAS' | translate }}</span>
</div>
}

@else if (!loading && !error && !selectedEmpresaId && !isAdmin) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    <span>{{ 'EVOLUCAO.NO_EMPRESA_ASSOCIATED' | translate }}</span>
</div>
}

@else if (!selectedEmpresaId && isAdmin) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    <span>{{ 'EVOLUCAO.SELECT_EMPRESA_PLACEHOLDER' | translate }}</span>
</div>
}