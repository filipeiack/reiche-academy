<div id="headerDashboard" class="sticky-header-dashboard mb-1">
    <div class="mb-2 align-items-center d-flex justify-content-between flex-wrap">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb breadcrumb-arrow">
                <li class="breadcrumb-item">
                    <i class="feather icon-clipboard"></i>
                </li>
                <li class="breadcrumb-item active" aria-current="page">
                    {{ 'DIAGNOSTICO.TITLE' | translate }}
                </li>
            </ol>
        </nav>

        @if (selectedEmpresaId) {
        <div id="savingBar" class="d-flex align-items-center gap-3">

            @if (savingCount > 0) {
            <div class="saving-indicator">
                <div class="spinner-border spinner-border-sm" role="status">
                    <span class="visually-hidden">{{ 'COMMON.SAVING' | translate }}...</span>
                </div>
                <span>{{ 'DIAGNOSTICO.SAVING_CHANGES' | translate }}</span>
            </div>
            } @else if (lastSaveTime) {
            <div class="last-save-info">
                <i class="feather icon-check-circle text-success icon-sm"></i>
                <span class="text-muted small">Salvo por último às: {{ getLastSaveTimeFormatted() }}</span>
            </div>
            }

            <!-- Badge indicador de período de avaliação ativo -->
            @if (periodoAtual) {
            <div class="badge bg-light text-dark small d-flex align-items-center gap-1 px-3 py-2">
                <i class="feather icon-calendar icon-sm"></i>
                <span>{{ getPeriodoAtualTexto() }}</span>
            </div>
            }

            <!-- Menu Dropdown de Ações -->
            @if (selectedEmpresaId && !isReadOnlyPerfil) {
            <div class="ms-2">
                <div ngbDropdown class="mb-2">
                    <a class="no-dropdown-toggle-icon" ngbDropdownToggle id="dropdownMenuButton">
                        <i class="feather icon-more-horizontal icon-xl"></i>
                    </a>
                    <div ngbDropdownMenu aria-labelledby="dropdownMenuButton">
                        <a ngbDropdownItem class="d-flex align-items-center gap-1"
                            (click)="abrirModalIniciarPeriodo(); $event.preventDefault()"
                            [class.disabled]="periodoAtual !== null">
                            <i class="feather icon-play-circle icon-sm"></i>
                            <span class="">Iniciar Avaliação Trimestral</span>
                        </a>
                        <a ngbDropdownItem class="d-flex align-items-center gap-1"
                            (click)="forceSaveAll(); $event.preventDefault()"
                            [class.disabled]="savingCount > 0 || !hasUnsavedChanges()">
                            <i class="feather icon-save icon-sm"></i>
                            <span class="">Salvar Tudo</span>
                        </a>
                        <a ngbDropdownItem class="d-flex align-items-center gap-1"
                            (click)="abrirModalPilares(); $event.preventDefault()">
                            <i class="feather icon-edit icon-sm"></i>
                            <span class="">Editar Pilares</span>
                        </a>
                    </div>
                </div>
            </div>
            }
        </div>
        }
    </div>
</div>



<!-- Conteúdo principal -->
@if (!loading && !error && selectedEmpresaId && pilares.length > 0) {

<div class="diagnostico-content">
    <!-- Accordion de Pilares -->
    @for (pilar of pilares; track pilar.id; let i = $index) {
    <div class="card mb-1" data-testid="pilar-accordion">
        <div class="card-header sticky-header-card mb-0 collapsed">
            <div class="pilar-header">
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-link p-0 d-flex align-items-center" type="button" (click)="togglePilar(i)">
                        <i [ngClass]="pilarExpandido[i] ? 'feather icon-chevron-up' : 'feather icon-chevron-down'"></i>
                        <span class="fw-bold text-muted">
                            {{ ('PILARES.PILAR' | translate).toUpperCase() }}
                            {{ pilar.nome.toUpperCase() }}
                        </span>
                    </button>
                </div>

                <div class="ms-auto d-flex align-items-center gap-3">

                    <span class="badge bg-light text-dark small d-inline-flex align-items-center">
                        {{ pilar.rotinasEmpresa.length }}
                        {{ pilar.rotinasEmpresa.length === 1 ? 'rotina' : 'rotinas' }}
                    </span>

                    @if (pilar.rotinasEmpresa.length > 0) {

                    <span class="badge bg-light text-dark small d-inline-flex align-items-center"
                        [title]="'Taxa de respostas para o ' + ('PILARES.PILAR' | translate) + ' ' + pilar.nome">
                        Tx respostas:
                        {{ getPilarProgress(pilar) | number:'1.0-0' }} %
                    </span>

                    <span class="d-inline-flex align-items-center">
                        <app-media-badge [media]="getPilarMediaNotas(pilar)"></app-media-badge>
                    </span>
                    }

                    <div ngbDropdown class="w-30px">
                        @if (pilarExpandido[i] && !isReadOnlyPerfil) {
                        <div ngbDropdown class="mb-2">
                            <a class="no-dropdown-toggle-icon btn btn-link" ngbDropdownToggle id="dropdownMenuButton">
                                <i class="feather icon-more-horizontal"></i>
                            </a>
                            <div ngbDropdownMenu aria-labelledby="dropdownMenuButton">
                                <a ngbDropdownItem class="d-flex align-items-center gap-1"
                                    (click)="abrirModalResponsavel(pilar); $event.preventDefault()">
                                    <i class="feather icon-user icon-sm"></i>
                                    <span class="">Definir Responsável</span>
                                </a>
                                <!-- <a ngbDropdownItem class="d-flex align-items-center gap-1"
                                    (click)="abrirModalNovaRotina(pilar); $event.preventDefault()">
                                    <i class="bi bi-plus-circle icon-sm"></i>
                                    <span class="">Adicionar Rotina</span>
                                </a> -->
                                <a ngbDropdownItem class="d-flex align-items-center gap-1"
                                    (click)="abrirModalEditarRotinas(pilar); $event.preventDefault()">
                                    <i class="feather icon-edit icon-sm"></i>
                                    <span class="">Editar Rotinas</span>
                                </a>

                                <div class="dropdown-divider"></div>

                                <!-- Botão Cockpit -->
                                <a ngbDropdownItem class="d-flex align-items-center gap-1"
                                    (click)="navegarParaCockpit(pilar); $event.preventDefault()">
                                    @if (pilar.cockpit) {
                                    <i class="feather icon-target icon-sm text-success"></i>
                                    <span class="">Abrir Cockpit</span>
                                    } @else {
                                    <i class="bi bi-plus-circle icon-sm text-primary"></i>
                                    <span class="">Criar Cockpit</span>
                                    }
                                </a>

                            </div>
                        </div>
                        }
                    </div>
                </div>
            </div>
        </div>

        @if (pilarExpandido[i]) {
        <div class="card-body mb-1">
            @if (pilar.rotinasEmpresa.length === 0) {
            <div class="empty-state">
                <i class="feather icon-inbox"></i>
                <p>{{ 'DIAGNOSTICO.NO_ROTINAS' | translate }}</p>
            </div>
            } @else {

            <div class="d-flex justify-content-end mb-2">
                <span class="text-muted form-label-xs b-0">
                    {{ 'DIAGNOSTICO.INSTRUCTIONS' | translate }}
                </span>
            </div>
            <ngb-alert class="gap-2 mb-0" [dismissible]="false" [type]="'primary'">
                <i class="feather icon-user icon-sm"></i>
                <span class="small text-muted">Responsável pelo pilar: {{ pilar.responsavel?.nome || 'Não atribuído'
                    }}</span>
            </ngb-alert>
            @for (rotina of pilar.rotinasEmpresa; track rotina.id) {
            <div class="row mb-1" data-testid="rotina-row">
                <div class="col-md-12 mb-1">
                    <div class="row justify-content-center align-items-center">
                        <div class="col-md-8">
                            <i class="feather icon-check-circle text-primary small"></i>
                            <span> {{ rotina.nome }} </span>
                        </div>

                        <div class="col-md-4 ">
                            <div class="row">
                                <!-- Campo Criticidade -->
                                <div class="col-md-7">
                                    <label [for]="'criticidade-' + rotina.id" class="form-label-xs">
                                        {{ 'DIAGNOSTICO.CRITICIDADE' | translate }} <span class="text-danger">*</span>
                                    </label>
                                    <select [id]="'criticidade-' + rotina.id" class="form-control" 
                                        [value]="getCriticidadeAtual(rotina)"
                                        (change)="onNotaChange(rotina, getNotaAtual(rotina), $any($event.target).value)"
                                        [ngClass]="getCriticidadeClass(getCriticidadeAtual(rotina))">
                                        <option *ngFor="let option of criticidadeOptions" [value]="option.value">
                                            {{ option.label }}
                                        </option>
                                    </select>
                                </div>

                                <!-- Campo Nota -->
                                <div class="col-md-5">
                                    <label [for]="'nota-' + rotina.id" class="form-label-xs">
                                        {{ 'DIAGNOSTICO.NOTA' | translate }} <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" [id]="'nota-' + rotina.id" class="form-control" min="0"
                                        max="10" step="1" [value]="getNotaAtual(rotina)"
                                        (input)="onNotaChange(rotina, $any($event.target).value, getCriticidadeAtual(rotina))"
                                        placeholder="0 - 10" [ngClass]="getNotaClass(getNotaAtual(rotina))" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- @if (rotina.rotina.descricao) {
                        <div class="mb-0">
                            <p class="rotina-descricao">
                                <i class="feather icon-info me-2"></i>
                                {{ rotina.rotina.descricao.toLowerCase() }}
                            </p>
                        </div>
                        } -->
            </div>
            <hr class="my-1" />
            }
            }
        </div>
        }
    </div>
    }
</div>

}

@else if (loading) {
<div class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}...</span>
    </div>
</div>
}

<!-- Error -->
@else if (error && !loading) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    {{ error }}
</div>
}

<!-- Estado vazio -->
@else if (!loading && !error && pilares.length === 0 && selectedEmpresaId) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    <span>{{ 'DIAGNOSTICO.NO_PILARES' | translate }}</span>
</div>
}

@else if (!loading && !error && !selectedEmpresaId && !isAdmin) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    <span>{{ 'DIAGNOSTICO.NO_EMPRESA_ASSOCIATED' | translate }}</span>
</div>
}

@else if (!selectedEmpresaId && isAdmin) {
<div class="alert alert-danger" role="alert">
    <i data-feather="alert-triangle" class="me-2"></i>
    <span>{{ 'DIAGNOSTICO.SELECT_EMPRESA_PLACEHOLDER' | translate }}</span>
</div>
}

<!-- Modal para editar pilares -->
<app-pilares-empresa-modal [empresaId]="selectedEmpresaId || ''" [isPerfilCliente]="isReadOnlyPerfil"
    (pilaresModificados)="onPilaresModificados()">
</app-pilares-empresa-modal>

<!-- Modal para definir responsável -->
<app-responsavel-pilar-modal [empresaId]="selectedEmpresaId || ''" (responsavelAtualizado)="onResponsavelAtualizado()">
</app-responsavel-pilar-modal>

<!-- Modal para criar nova rotina -->
<app-nova-rotina-modal [empresaId]="selectedEmpresaId || ''" (rotinaCriada)="onRotinaCriada()">
</app-nova-rotina-modal>

<!-- Modal para editar rotinas do pilar -->
<app-rotinas-pilar-modal (rotinasModificadas)="onRotinasModificadas()">
</app-rotinas-pilar-modal>

<!-- Modal para iniciar período de avaliação -->
@if (showIniciarPeriodoModal) {
<div class="modal fade show d-block" tabindex="-1" role="dialog" style="background: rgba(0,0,0,0.5);">
    <div class="modal-dialog modal-dialog-centered" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="feather icon-calendar me-2"></i>
                    Iniciar Nova Avaliação Trimestral
                </h5>
                <button type="button" class="btn-close" (click)="fecharModalIniciarPeriodo()"></button>
            </div>
            <div class="modal-body">
                <p class="text-muted mb-3">
                    Selecione a data de referência para o novo período de avaliação.
                </p>

                <div class="mb-3">
                    <label for="dataReferencia" class="form-label">Data de Referência *</label>
                    <input type="date" class="form-control" id="dataReferencia" [(ngModel)]="dataReferenciaPeriodo"
                        required>

                </div>

                <div class="alert alert-info mb-0">
                    <i class="feather icon-info me-2"></i>
                    <small>
                        O intervalo mínimo entre períodos é de <strong>90 dias</strong>,
                        calculado com base nas datas de referência escolhidas.
                    </small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" (click)="fecharModalIniciarPeriodo()">
                    Cancelar
                </button>
                <button type="button" class="btn btn-primary" (click)="confirmarIniciarPeriodo()"
                    [disabled]="!dataReferenciaPeriodo">
                    <i class="feather icon-check me-2"></i>
                    Iniciar Período
                </button>
            </div>
        </div>
    </div>
</div>
}