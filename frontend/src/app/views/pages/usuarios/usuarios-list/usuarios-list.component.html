<div class="mb-2 align-items-center gap-2 d-flex justify-content-between flex-wrap">
  <nav aria-label="breadcrumb">
    <ol class="breadcrumb breadcrumb-arrow mb-1">
      <li class="breadcrumb-item">
        <i class="feather icon-users"></i>
      </li>
      <li class="breadcrumb-item active" aria-current="page">
        {{ "MENU.USUARIOS" | translate }}
      </li>
    </ol>
  </nav>

  <button data-testid="novo-usuario-button" id="btnNovo" type="button" class="btn btn-outline-primary btn-sm" [routerLink]="['/usuarios/novo']">
    <i class="bi bi-plus-circle btn-icon-prepend"></i>
    {{ 'USERS.ADD' | translate }}
  </button>
</div>

<div class="row">
  <div class="col-md-12 stretch-card">
    <div class="card">
      <div class="card-body">
        <div class="row">
          <div class="col-md-6">
            <div class="input-icon search-inline">
              <span class="input-icon-addon">
                <i class="feather icon-search"></i>
              </span>
              <input type="text" class="form-control" placeholder="{{ 'COMMON.SEARCH' | translate }}"
                [value]="searchQuery" (input)="onSearchInput($event)" />
            </div>
          </div>

          <div class="col-md-6 text-end">

            @if (selectedCount > 0) {
            
              <button type="button" class="btn btn-xs btn-outline-danger" (click)="deleteSelectedUsuarios()">
                {{ "BUTTONS.DELETE_SELECTED" | translate }} ({{ selectedCount }})
              </button>
            
            }
          </div>
        </div>

        <div class="table-responsive">

          @if (loading) {
          <div class="text-center py-5">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}...</span>
            </div>
          </div>
          } @else {
          <div class="table-responsive">
            <table class="table table-hover table-sm mb-2">
              <thead class="table-light">
                <tr>
                  <!-- <th><input class="form-check-input" type="checkbox" [(ngModel)]="headerCheckboxChecked"
                      (change)="toggleHeaderCheckbox()"></th> -->
                  <th scope="col" sortable="name" (sort)="onSort($event)">{{ 'USERS.NAME' | translate }}</th>
                  <th scope="col" sortable="email" (sort)="onSort($event)">{{ 'USERS.EMAIL' | translate }}</th>
                  <th>{{ 'USERS.ROLE' | translate }}</th>
                  <th>{{ 'USERS.STATUS' | translate }}</th>
                  <th>{{ 'COMMON.ACTIONS' | translate }}</th>
                </tr>
              </thead>
              <tbody>
                @for (usuario of paginatedUsuarios; track usuario.id) {
                <tr>
                  <!-- <td>
                    <input class="form-check-input" type="checkbox" [checked]="isUsuarioSelected(usuario.id)"
                      (change)="toggleUsuarioSelection(usuario.id)">
                  </td> -->
                  <td>{{ usuario.nome }}</td>
                  <td class="text-muted">{{ usuario.email }}</td>
                  <td>{{ getPerfilLabel(usuario.perfil) }}</td>
                  <td class="text-muted">
                    <!-- <span class="badge" [ngClass]="{'bg-success': usuario.ativo, 'bg-danger': !usuario.ativo}"> -->
                    {{ usuario.ativo ? ('COMMON.ACTIVE' | translate) : ('COMMON.INACTIVE' | translate) }}
                    <!-- </span> -->
                  </td>
                  <td class="text-nowrap">
                    <div class="btn-group btn-group-sm" role="group">
                      <button class="btn btn-icon text-primary"
                        (click)="openDetailsOffcanvas(usuario.id, detailsOffcanvas)"
                        [title]="'Detalhes do usuário' | translate">
                        <i class="feather icon-info"></i>
                      </button>
                      <button class="btn btn-icon text-primary"
                        (click)="toggleStatusUsuario(usuario.id, usuario.nome, usuario.ativo)"
                        [title]="usuario.ativo ? 'Inativar usuário' : 'Ativar usuário'">
                        <i class="feather"
                          [ngClass]="{'icon-toggle-right': usuario.ativo, 'icon-toggle-left text-danger': !usuario.ativo}"></i>
                      </button>
                      <button data-testid="edit-usuario-button" class="btn btn-icon text-secondary" [routerLink]="['/usuarios', usuario.id, 'editar']"
                        title="{{ 'BUTTONS.EDIT' | translate }}">
                        <i class="feather icon-edit"></i>
                      </button>
                      <button data-testid="delete-usuario-button" class="btn btn-icon text-danger" (click)="deleteUsuario(usuario.id, usuario.nome)"
                        title="{{ 'BUTTONS.DELETE' | translate }}">
                        <i class="feather icon-trash-2"></i>
                      </button>
                    </div>
                  </td>
                </tr>

                } @empty {
                <tr>
                  <td colspan="7" class="border-bottom text-center text-muted py-4">
                    {{ 'COMMON.NO_DATA' | translate }}
                  </td>
                </tr>
                }

              </tbody>
            </table>
          </div>

          <!-- Paginacao -->
          <div class="d-flex justify-content-between p-2">
            <!-- <select class="form-select" style="width: auto" [(ngModel)]="pageSize" (ngModelChange)="paginatedUsuarios">
              <option [ngValue]="2">2 items per page</option>
              <option [ngValue]="4">4 items per page</option>
              <option [ngValue]="6">6 items per page</option>
            </select> -->

            <span class="text-muted fs-12">
              Mostrando {{ getStartIndex() + 1 }}-{{ getEndIndex() }} de {{ filteredUsuarios.length }} {{ 'COMMON.ITEMS' | translate }}
            </span>

            @if (totalPages > 1) {
              <ngb-pagination [collectionSize]="filteredUsuarios.length" [(page)]="currentPage" size="sm"
                [pageSize]="pageSize" (pageChange)="paginatedUsuarios">
              </ngb-pagination>
            }
          </div>
          }
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Offcanvas de Detalhes do Usuário -->
<ng-template #detailsOffcanvas let-offcanvas>
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">{{ 'USERS.DETAILS' | translate }}</h5>
    <button type="button" class="btn-close text-reset" (click)="offcanvas.dismiss()"></button>
  </div>
  <div class="offcanvas-body">
    @if (loadingDetails) {
    <div class="text-center py-5">
      <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">{{ 'COMMON.LOADING' | translate }}...</span>
      </div>
      <p class="text-muted mt-3">{{ 'COMMON.LOADING' | translate }}...</p>
    </div>
    } @else if (selectedUsuario) {
    <div class="mb-4 text-center">
      <div class="mb-3 d-flex justify-content-center">
        <app-user-avatar [nome]="selectedUsuario.nome" [fotoUrl]="selectedUsuario.fotoUrl"
          size="large"></app-user-avatar>
      </div>
      <h4 class="mb-1">{{ selectedUsuario.nome }}</h4>
      <p class="text-muted">{{ selectedUsuario.cargo }}</p>
      <span class="badge" [ngClass]="{'bg-success': selectedUsuario.ativo, 'bg-danger': !selectedUsuario.ativo}">
        {{ selectedUsuario.ativo ? ('COMMON.ACTIVE' | translate) : ('COMMON.INACTIVE' | translate) }}
      </span>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h6 class="card-title mb-3">{{ 'COMMON.BASIC_INFO' | translate }}</h6>

        <div class="mb-3">
          <label class="text-muted small">{{ 'USERS.EMAIL' | translate }}</label>
          <p class="mb-0">{{ selectedUsuario.email }}</p>
        </div>

        <div class="mb-3">
          <label class="text-muted small">Telefone</label>
          <p class="mb-0">{{ selectedUsuario.telefone || '-' }}</p>
        </div>

        <div class="mb-3">
          <label class="text-muted small">{{ 'USERS.ROLE' | translate }}</label>
          <p class="mb-0">
            {{ getPerfilLabel(selectedUsuario.perfil) }}
          </p>
        </div>

        <div class="mb-3">
          <label class="text-muted small">{{ 'USERS.CARGO' | translate }}</label>
          <p class="mb-0">{{ selectedUsuario.cargo || '-' }}</p>
        </div>

        <div class="mb-3">
          <label class="text-muted small">Empresa</label>
          <p class="mb-0">
            @if (selectedUsuario.empresa) {
              {{ selectedUsuario.empresa.nome }}
            } @else {
              <span class="text-muted">Não associado</span>
            }
          </p>
        </div>

        <!-- <div class="mb-3">
          <label class="text-muted small">{{ 'USERS.STATUS' | translate }}</label>
          <p class="mb-0">
            <span class="badge" [ngClass]="{'bg-success': selectedUsuario.ativo, 'bg-danger': !selectedUsuario.ativo}">
              {{ selectedUsuario.ativo ? ('COMMON.ACTIVE' | translate) : ('COMMON.INACTIVE' | translate) }}
            </span>
          </p>
        </div> -->
      </div>
    </div>

    <div class="card mb-3">
      <div class="card-body">
        <h6 class="card-title mb-3">{{ 'COMMON.TIMESTAMPS' | translate }}</h6>

        <div class="mb-3">
          <label class="text-muted small">{{ 'COMMON.CREATED_AT' | translate }}</label>
          <p class="mb-0">{{ selectedUsuario.createdAt | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>

        <div class="mb-0">
          <label class="text-muted small">{{ 'COMMON.UPDATED_AT' | translate }}</label>
          <p class="mb-0">{{ selectedUsuario.updatedAt | date:'dd/MM/yyyy HH:mm' }}</p>
        </div>
      </div>
    </div>

    <div class="d-grid gap-2">
      <button type="button" class="btn btn-primary" [routerLink]="['/usuarios', selectedUsuario.id, 'editar']"
        (click)="offcanvas.dismiss()">
        <i class="feather icon-edit"></i> {{ 'BUTTONS.EDIT' | translate }}
      </button>

      <!-- <button type="button" class="btn btn-outline-secondary"
        (click)="toggleStatusUsuario(selectedUsuario.id, selectedUsuario.nome, selectedUsuario.ativo); offcanvas.dismiss()">
        <i class="feather"
          [ngClass]="{'icon-toggle-right': selectedUsuario.ativo, 'icon-toggle-left': !selectedUsuario.ativo}"></i>
        {{ selectedUsuario.ativo ? 'Inativar' : 'Ativar' }}
      </button> -->

      <!-- <button type="button" class="btn btn-outline-danger" 
                (click)="deleteUsuario(selectedUsuario.id, selectedUsuario.nome); offcanvas.dismiss()">
          <i class="feather icon-trash-2"></i> {{ 'BUTTONS.DELETE' | translate }}
        </button> -->
    </div>
    }
  </div>
</ng-template>