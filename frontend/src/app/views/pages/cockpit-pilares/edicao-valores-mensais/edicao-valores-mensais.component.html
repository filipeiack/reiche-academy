<div class="edicao-valores-wrapper">
  <!-- Loading -->
  @if (loading) {
  <div class="text-center py-4">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Carregando...</span>
    </div>
  </div>
  }

  <!-- Indicadores -->
  @if (!loading) {
  @if (indicadores.length === 0) {
  <div class="alert alert-info">
    <i class="bi bi-info-circle me-2"></i>
    Nenhum indicador criado ainda. Adicione indicadores para começar.
  </div>
  } @else {
  @for (indicador of indicadores; track indicador.id) {
  <div class="card mb-1">
    <div class="card-body p-3 px-4">
      <!-- Header do Indicador -->
      <div class="indicador-header d-flex justify-content-between align-items-center mb-1 flex-wrap gap-2">
        <div>
          <h6 class="mb-0">
            <span class="badge bg-primary me-2">{{ $index + 1 }}</span>
            {{ indicador.nome.toUpperCase() }}
          </h6>
          @if (indicador.descricao) {
          <small class="text-muted ms-2">({{ indicador.descricao }})</small>
          }
        </div>

        <!-- Detalhes do Indicador -->
        <div class="d-flex flex-wrap gap-2">

          <!-- <div class="badge bg-light gap-1 p-2">
            <label class="form-label small text-muted mb-2">Tipo</label>
            <div class="fw-bold text-dark">
              ({{ getLabelTipoMedida(indicador.tipoMedida) }})
            </div>
          </div> -->

          <div class="badge bg-light gap-1 p-2">
            <label class="form-label small text-muted mb-2">Status</label>
            <div class="fw-bold text-dark">
              @switch (indicador.statusMedicao) {
              @case ('MEDIDO_CONFIAVEL') {
              <span class="badge bg-success">Medido e confiável</span>
              }
              @case ('MEDIDO_NAO_CONFIAVEL') {
              <span class="badge bg-warning">Medido, mas não é confiável.</span>
              }
              @case ('NAO_MEDIDO') {
              <span class="badge bg-danger">Não é medido</span>
              }
              }
            </div>
          </div>

          <div class="badge bg-light gap-1 p-2">
            <label class="form-label small text-muted mb-2">Responsável</label>
            <div class="fw-bold text-dark">
              {{ indicador.responsavelMedicao?.nome || 'Não definido' }}
            </div>
          </div>

          <!-- <div class="badge bg-light gap-1 p-2 ">
            <label class="form-label small text-muted mb-2">Melhor</label>
            <div class="fw-bold text-dark">
              @if (indicador.melhor === 'MAIOR') {
              <i class="bi bi-arrow-up-circle text-black"></i>
              } @else {
              <i class="bi bi-arrow-down-circle text-black"></i>
              }
            </div>
          </div> -->

        </div>
      </div>

      <!-- Tabela Mensal -->
      <!-- Header fixo fora do table-responsive para permitir sticky correto -->
      <div class="table-header-wrapper">
        <table class="table table-hover table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th style="width: 80px;">Mês</th>
              <th class="text-center" style="width: 60px;">Melhor</th>
              <th style="width: 120px;">Histórico
                ({{ getLabelTipoMedida(indicador.tipoMedida) }})
              </th>
              <th style="width: 120px;">Meta
                ({{ getLabelTipoMedida(indicador.tipoMedida) }})
              </th>
              <th style="width: 120px;">Realizado
                ({{ getLabelTipoMedida(indicador.tipoMedida) }})
              </th>
              <th  style="width: 100px;">Desvio</th>
              <th class="text-center" style="width: 100px;">Status</th>
            </tr>
          </thead>
        </table>
      </div>

      <!-- Corpo da tabela com scroll -->
      <div class="table-responsive">
        <table class="table table-hover table-sm">
          <tbody>
            @for (mes of getMesesOrdenados(indicador); track mes.id) {
            <tr>
              <td class="fw-bold" style="width: 80px;">{{ getNomeMes(mes.mes!) }}</td>
              <td class="text-center" style="width: 60px;">
                @if (indicador.melhor === 'MAIOR') {
                <i class="bi bi-arrow-up-circle text-black" style="font-size: 1.25rem;"></i>
                } @else {
                <i class="bi bi-arrow-down-circle text-black" style="font-size: 1.25rem;"></i>
                }
              </td>
              <td style="width: 120px;">
                <input type="number" class="form-control form-control-sm" [value]="mes.historico"
                  (input)="onValorChange(mes, 'historico', $event)" step="1" />
              </td>
              <td style="width: 120px;">
                <input type="number" class="form-control form-control-sm" [value]="mes.meta"
                  (input)="onValorChange(mes, 'meta', $event)" step="1" />
              </td>
              <td style="width: 120px;">
                <input type="number" class="form-control form-control-sm" [value]="mes.realizado"
                  (input)="onValorChange(mes, 'realizado', $event)" step="1" />
              </td>
              <td class="text-center" style="width: 100px;">
                @if (mes.meta && mes.realizado) {
                <div class="d-flex flex-column gap-1">
                  <span [class]="'badge bg-' + calcularStatus(indicador, mes)" style="font-size: 0.75rem;">
                    {{ calcularDesvioAbsoluto(indicador, mes) | number: '1.2-2' }} ({{ getLabelTipoMedida(indicador.tipoMedida) }})
                  </span>
                  <span [class]="'badge bg-' + calcularStatus(indicador, mes)" style="font-size: 0.75rem;">
                    {{ calcularDesvio(indicador, mes) | number: '1.1-1' }}%
                  </span>
                </div>
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
              <td class="text-center" style="width: 100px; font-size: 1.25rem;">
                @if (calcularStatus(indicador, mes); as status) {
                @switch (status) {
                @case ('success') {
                <i class="bi bi-check-circle-fill text-success"></i>
                }
                @case ('warning') {
                <i class="bi bi-exclamation-triangle-fill text-warning"></i>
                }
                @case ('danger') {
                <i class="bi bi-x-circle-fill text-danger"></i>
                }
                }
                } @else {
                <span class="text-muted">-</span>
                }
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>
    </div>
  </div>
  }
  }
  }
</div>