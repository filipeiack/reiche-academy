generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ===== ENUMS =====

enum Criticidade {
  ALTO
  MEDIO
  BAIXO
}

enum StatusAcao {
  PENDENTE
  EM_ANDAMENTO
  CONCLUIDA
  CANCELADA
}

enum EstadoBrasil {
  AC
  AL
  AP
  AM
  BA
  CE
  DF
  ES
  GO
  MA
  MT
  MS
  MG
  PA
  PB
  PR
  PE
  PI
  RJ
  RN
  RS
  RO
  RR
  SC
  SP
  SE
  TO
}

// ===== MODELS =====

model PerfilUsuario {
  id          String    @id @default(uuid())
  codigo      String    @unique  // ADMINISTRADOR, CONSULTOR, GESTOR, COLABORADOR, LEITURA
  nome        String               // "Administrador", "Consultor", etc
  descricao   String?
  nivel       Int                  // 1 (maior poder) a 5 (menor poder)
  ativo       Boolean   @default(true)
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  
  // Relations
  usuarios    Usuario[]
  
  @@map("perfis_usuario")
}

model Usuario {
  id        String   @id @default(uuid())
  email     String   @unique
  nome      String
  senha     String
  cargo     String
  fotoUrl   String?
  ativo     Boolean  @default(true)
  
  perfilId  String
  perfil    PerfilUsuario @relation(fields: [perfilId], references: [id])
  
  empresaId String?
  empresa   Empresa? @relation(fields: [empresaId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  createdBy String?
  updatedBy String?
  
  // Relations
  reunioes      AgendaReuniao[]
  passwordResets PasswordReset[]
  loginHistory   LoginHistory[]

  @@map("usuarios")
}

model PasswordReset {
  id        String   @id @default(uuid())
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  
  usuarioId String
  usuario   Usuario  @relation(fields: [usuarioId], references: [id], onDelete: Cascade)
  
  createdAt DateTime @default(now())
  
  @@index([token])
  @@index([usuarioId])
  @@map("password_resets")
}

model LoginHistory {
  id          String   @id @default(uuid())
  
  usuarioId   String?
  usuario     Usuario? @relation(fields: [usuarioId], references: [id], onDelete: SetNull)
  
  email       String
  sucesso     Boolean
  motivoFalha String?
  
  ipAddress   String?
  userAgent   String?
  dispositivo String?
  navegador   String?
  
  createdAt   DateTime @default(now())
  
  @@index([usuarioId])
  @@index([email])
  @@index([createdAt])
  @@index([sucesso])
  @@map("login_history")
}

model Empresa {
  id            String   @id @default(uuid())
  nome          String
  cnpj          String   @unique
  tipoNegocio   String?
  cidade        String
  estado        EstadoBrasil
  ativo         Boolean  @default(true)
  
  // Personalização
  logoUrl       String?
  loginUrl      String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?
  
  // Relations
  usuarios      Usuario[]
  pilares       PilarEmpresa[]
  
  @@map("empresas")
}

model Pilar {
  id          String   @id @default(uuid())
  nome        String   @unique
  descricao   String?
  ordem       Int
  modelo      Boolean  @default(false)
  ativo       Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  // Relations
  rotinas     Rotina[]
  empresas    PilarEmpresa[]
  
  @@map("pilares")
}

model Rotina {
  id          String   @id @default(uuid())
  nome        String
  descricao   String?
  ordem       Int
  modelo      Boolean  @default(false)
  ativo       Boolean  @default(true)
  
  pilarId     String
  pilar       Pilar    @relation(fields: [pilarId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  // Relations
  rotinaEmpresas RotinaEmpresa[]
  
  @@map("rotinas")
}

model PilarEmpresa {
  id          String   @id @default(uuid())
  
  empresaId   String
  empresa     Empresa  @relation(fields: [empresaId], references: [id])
  
  pilarId     String
  pilar       Pilar    @relation(fields: [pilarId], references: [id])
  
  ativo       Boolean  @default(true)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  // Relations
  rotinasEmpresa RotinaEmpresa[]
  evolucao       PilarEvolucao[]
  
  @@unique([empresaId, pilarId])
  @@map("pilares_empresa")
}

model RotinaEmpresa {
  id            String      @id @default(uuid())
  
  pilarEmpresaId String
  pilarEmpresa   PilarEmpresa @relation(fields: [pilarEmpresaId], references: [id], onDelete: Cascade)
  
  rotinaId      String
  rotina        Rotina      @relation(fields: [rotinaId], references: [id])
  
  observacao    String?
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  createdBy     String?
  updatedBy     String?
  
  // Relations
  notas         NotaRotina[]
  
  @@index([pilarEmpresaId])
  @@index([rotinaId])
  @@unique([pilarEmpresaId, rotinaId])
  @@map("rotinas_empresa")
}

model NotaRotina {
  id            String      @id @default(uuid())

  rotinaEmpresaId String
  rotinaEmpresa   RotinaEmpresa @relation(fields: [rotinaEmpresaId], references: [id], onDelete: Cascade)

  nota          Float?      // 0-10
  criticidade   Criticidade?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@index([rotinaEmpresaId])
  @@map("nota_rotinas")
}

model PilarEvolucao {
  id            String      @id @default(uuid())

  pilarEmpresaId String
  pilarEmpresa   PilarEmpresa @relation(fields: [pilarEmpresaId], references: [id], onDelete: Cascade)

  mediaNotas          Float?      // 0-10

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@map("pilares_evolucao")
}

model AgendaReuniao {
  id          String   @id @default(uuid())
  titulo      String
  descricao   String?
  dataHora    DateTime
  duracao     Int?     // em minutos
  local       String?
  link        String?

  usuarioId   String
  usuario     Usuario  @relation(fields: [usuarioId], references: [id])
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  createdBy   String?
  updatedBy   String?
  
  @@index([usuarioId])
  @@map("agenda_reunioes")
}

model AuditLog {
  id          String   @id @default(uuid())
  
  usuarioId   String   // ID para referência (se precisar)
  usuarioNome String   // Nome no momento da ação
  usuarioEmail String  // Email no momento da ação
  
  entidade    String   // Nome da tabela
  entidadeId  String   // ID do registro
  acao        String   // CREATE, UPDATE, DELETE
  dadosAntes  Json?    // Estado anterior
  dadosDepois Json?    // Estado posterior
  
  createdAt   DateTime @default(now())
  
  @@index([entidade, entidadeId])
  @@index([usuarioId])
  @@map("audit_logs")
}
